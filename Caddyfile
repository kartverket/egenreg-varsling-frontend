{
    auto_https off
}

:{$PORT}

@backendUrls {
    path /api/*
}

@varslingbackendUrls {
    path /kommuneordre/*
}

route @backendUrls {
    reverse_proxy meldingstjeneste:8080 {
        header_up Host {upstream_hostport}
    }
}

route @varslingbackendUrls {
    reverse_proxy egenreg-varsling-backend:8080 {
        header_up Host {upstream_hostport}
    }
}

log {
    output stdout
    format console
}

encode gzip

route {
    try_files {path} /index.html
}

header * {
    Strict-Transport-Security: max-age=31536000
    X-Content-Type-Options nosniff
    X-XSS-Protection "1"
    Referrer-Policy "strict-origin"
    Content-Security-Policy "default-src 'none'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; script-src 'self' 'sha256-8ZgGo/nOlaDknQkDUYiedLuFRSGJwIz6LAzsOrNxhmU='; font-src 'self' https://fonts.gstatic.com; media-src 'self'; img-src 'self' data:; form-action 'self'; connect-src 'self'; base-uri 'none'; worker-src 'self' blob:; frame-ancestors 'self';",

    Permissions-Policy "geolocation=(),midi=(),microphone=(),camera=(),magnetometer=(),gyroscope=(),payment=()"
}

@fonts {
    path_regexp fonts \.(woff2?|eot|ttf|otf)$
}

header @fonts Cache-Control "public, max-age=31536000, immutable"

file_server